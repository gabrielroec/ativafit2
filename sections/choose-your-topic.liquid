{%- comment -%} 
    Choose Your Topic Section
     
    Theme Editor Configuration: 
    1. Add blocks for each tab (each block = one blog tab) 
    2. Each block needs: tab_label, blog, default_active 
    3. Configure initial posts count and load more amount 
    4. Enable/disable search and filter
     
    How to add new tabs: 
    - Click "Add block" in Theme Editor 
    - Select "Blog Tab" block type 
    - Set tab label and select blog 
    - Mark as default_active if it should be the first active tab 
{%- endcomment -%}

{%- liquid
  assign show_search = section.settings.show_search
  assign show_filter = section.settings.show_filter

  comment Find the default active tab
  endcomment
  assign active_tab_id = blank
  for block in section.blocks
    if block.settings.default_active
      assign active_tab_id = block.id
      break
    endif
  endfor

  comment If no default active, use first block
  endcomment
  if active_tab_id == blank and section.blocks.size > 0
    assign active_tab_id = section.blocks.first.id
  endif
-%}

<section
  data-section-id="{{ section.id }}"
  data-section-type="choose-your-topic"
  class="choose-your-topic"
  style="
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    {% if section.settings.section_bg != blank %}background-color: {{ section.settings.section_bg }};{% endif %}
  ">
  <div class="choose-your-topic__container">
    {%- if section.settings.title != blank -%}
      <h2 class="choose-your-topic__title">{{ section.settings.title }}</h2>
    {%- endif -%}

    {%- if section.blocks.size > 0 -%}
      {%- comment -%} Tab Navigation {%- endcomment -%}
      <div class="choose-your-topic__tabs-wrapper">
        <div
          class="choose-your-topic__tabs"
          role="tablist"
          aria-label="Blog topics">
          {%- for block in section.blocks -%}
            {%- assign is_active = false -%}
            {%- if block.id == active_tab_id -%}
              {%- assign is_active = true -%}
            {%- endif -%}

            <button
              class="choose-your-topic__tab{% if is_active %} choose-your-topic__tab--active{% endif %}"
              role="tab"
              aria-selected="{% if is_active %}true{% else %}false{% endif %}"
              aria-controls="panel-{{ block.id }}"
              id="tab-{{ block.id }}"
              data-tab-id="{{ block.id }}"
              data-blog-handle="{% if block.settings.blog != blank %}{{ blogs[block.settings.blog].handle }}{% endif %}"
              {{ block.shopify_attributes }}>
              {{ block.settings.tab_label | default: 'Tab' }}
            </button>
          {%- endfor -%}
        </div>
      </div>

      {%- comment -%} Filters and Search {%- endcomment -%}
      <div class="choose-your-topic__filters">
        {%- if show_filter -%}
          <div class="choose-your-topic__filter-wrapper">
            <label for="category-filter-{{ section.id }}" class="visually-hidden">Filter by category</label>
            <select
              id="category-filter-{{ section.id }}"
              class="choose-your-topic__filter-select"
              data-filter="category"
              aria-label="Filter by category">
              <option value="">All categories</option>
            </select>
          </div>
        {%- endif -%}

        {%- if show_search -%}
          <div class="choose-your-topic__search-wrapper">
            <label for="search-input-{{ section.id }}" class="visually-hidden">Search articles</label>
            <input
              type="text"
              id="search-input-{{ section.id }}"
              class="choose-your-topic__search-input"
              placeholder="Search articles"
              data-search="input"
              aria-label="Search articles">
            <button
              type="button"
              class="choose-your-topic__search-clear"
              data-search="clear"
              aria-label="Clear search"
              style="display: none;">
              Ã—
            </button>
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} Tab Panels {%- endcomment -%}
      <div class="choose-your-topic__panels">
        {%- for block in section.blocks -%}
          {%- assign is_active = false -%}
          {%- if block.id == active_tab_id -%}
            {%- assign is_active = true -%}
          {%- endif -%}

          {%- assign selected_blog = blogs[block.settings.blog] -%}

          <div
            class="choose-your-topic__panel{% if is_active %} choose-your-topic__panel--active{% endif %}"
            role="tabpanel"
            id="panel-{{ block.id }}"
            aria-labelledby="tab-{{ block.id }}"
            data-panel-id="{{ block.id }}"
            data-blog-handle="{% if selected_blog != blank %}{{ selected_blog.handle }}{% endif %}"
            {{ block.shopify_attributes }}>
            {%- if selected_blog != blank and selected_blog.articles.size > 0 -%}
              {%- comment -%} Section Title (from active blog) {%- endcomment -%}
              <h3 class="choose-your-topic__panel-title">{{ selected_blog.title }}</h3>

              {%- comment -%} Collect all unique tags from this blog {%- endcomment -%}
              {%- assign blog_tags_string = '' -%}
              {%- for article in selected_blog.articles -%}
                {%- for tag in article.tags -%}
                  {%- assign tag_lower = tag | downcase -%}
                  {%- unless blog_tags_string contains tag_lower -%}
                    {%- if blog_tags_string == '' -%}
                      {%- assign blog_tags_string = tag -%}
                    {%- else -%}
                      {%- assign blog_tags_string = blog_tags_string | append: '|' | append: tag -%}
                    {%- endif -%}
                  {%- endunless -%}
                {%- endfor -%}
              {%- endfor -%}
              {%- assign blog_tags = blog_tags_string | split: '|' -%}

              {%- comment -%} Articles Grid {%- endcomment -%}
              <div class="choose-your-topic__grid" data-articles-container>
                {%- for article in selected_blog.articles -%}
                  <div
                    class="choose-your-topic__article-item"
                    data-article-id="{{ article.id }}"
                    data-article-title="{{ article.title | downcase | escape }}"
                    data-article-excerpt="{{ article.excerpt | default: article.content | strip_html | downcase | escape }}"
                    data-article-tags="{% for tag in article.tags %}{{ tag | downcase | escape }}{% unless forloop.last %},{% endunless %}{% endfor %}">
                    {%- render 'blog-card'
                      ,
 article: article
                      ,
 show_blog_tag: true
                      ,
 show_author: true
                      ,
 show_date: true
                      ,
 show_read_time: true
                      ,
 image_aspect: 'card'
                      ,
 classes: 'choose-your-topic__card'
                    -%}
                  </div>
                {%- endfor -%}
              </div>

              {%- comment -%} Empty State (hidden by default, shown via JS when filtered) {%- endcomment -%}
              <div class="choose-your-topic__empty" style="display: none;">
                <p class="choose-your-topic__empty-text">No articles found</p>
              </div>

              {%- comment -%} Store tags in data attribute for JS {%- endcomment -%}
              <script type="application/json" data-blog-tags>
                [
                  {%- for tag in blog_tags -%}
                    "{{ tag | escape }}"{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ]
              </script>
            {%- else -%}
              {%- comment -%} Empty state when blog has no articles {%- endcomment -%}
              <div class="choose-your-topic__empty">
                <p class="choose-your-topic__empty-text">No articles found</p>
              </div>
            {%- endif -%}
          </div>
        {%- endfor -%}
      </div>
    {%- else -%}
      {%- comment -%} Empty state when no blocks {%- endcomment -%}
      <div class="choose-your-topic__empty">
        <p class="choose-your-topic__empty-text">Please add blog tabs in the section settings.</p>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
  /* Choose Your Topic Section */
  .choose-your-topic {
    width: 100%;
  }

  .choose-your-topic__container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .choose-your-topic__title {
    font-size: 42px;
    font-weight: 700;
    text-align: center;
    margin: 0 0 40px;
    color: #333;
  }

  /* Tabs Navigation */
  .choose-your-topic__tabs-wrapper {
    margin-bottom: 30px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .choose-your-topic__tabs-wrapper::-webkit-scrollbar {
    display: none;
  }

  .choose-your-topic__tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid #e5e5e5;
    min-width: fit-content;
  }

  .choose-your-topic__tab {
    padding: 16px 24px;
    border: none;
    background: transparent;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    cursor: pointer;
    position: relative;
    white-space: nowrap;
    transition: color 0.3s ease;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
  }

  .choose-your-topic__tab:hover {
    color: #333;
  }

  .choose-your-topic__tab--active {
    color: #000;
    border-bottom-color: #ff6b9d;
  }

  .choose-your-topic__tab:focus {
    outline: 2px solid #333;
    outline-offset: 2px;
  }

  /* Filters and Search */
  .choose-your-topic__filters {
    display: flex;
    gap: 16px;
    margin-bottom: 40px;
    flex-wrap: wrap;
  }

  .choose-your-topic__filter-wrapper {
    flex: 0 0 auto;
  }

  .choose-your-topic__filter-select {
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
    cursor: pointer;
    min-width: 180px;
    transition: border-color 0.3s ease;
  }

  .choose-your-topic__filter-select:focus {
    outline: none;
    border-color: #333;
  }

  .choose-your-topic__search-wrapper {
    flex: 1;
    min-width: 200px;
    position: relative;
    display: flex;
    align-items: center;
  }

  .choose-your-topic__search-input {
    width: 100%;
    padding: 12px 40px 12px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .choose-your-topic__search-input:focus {
    outline: none;
    border-color: #333;
  }

  .choose-your-topic__search-clear {
    position: absolute;
    right: 12px;
    background: none;
    border: none;
    font-size: 24px;
    line-height: 1;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.3s ease;
  }

  .choose-your-topic__search-clear:hover {
    color: #333;
  }

  .choose-your-topic__search-clear:focus {
    outline: 2px solid #333;
    outline-offset: 2px;
    border-radius: 2px;
  }

  /* Tab Panels */
  .choose-your-topic__panels {
    position: relative;
  }

  .choose-your-topic__panel {
    display: none;
  }

  .choose-your-topic__panel--active {
    display: block;
  }

  .choose-your-topic__panel-title {
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 30px;
    color: #333;
  }

  /* Articles Grid */
  .choose-your-topic__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
    margin-bottom: 40px;
  }

  .choose-your-topic__article-item {
    opacity: 1;
    transition: opacity 0.3s ease;
  }

  .choose-your-topic__article-item--filtered {
    display: none;
  }

  .choose-your-topic__card {
    height: 100%;
  }

  /* Empty State */
  .choose-your-topic__empty {
    text-align: center;
    padding: 60px 20px;
  }

  .choose-your-topic__empty-text {
    font-size: 16px;
    color: #666;
  }

  /* Visually Hidden */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* Responsive - Tablet */
  @media screen and (min-width: 768px) {
    .choose-your-topic__grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .choose-your-topic__filters {
      flex-wrap: nowrap;
    }

    .choose-your-topic__search-wrapper {
      flex: 1;
    }
  }

  /* Responsive - Desktop */
  @media screen and (min-width: 1024px) {
    .choose-your-topic__title {
      font-size: 48px;
      margin-bottom: 50px;
    }

    .choose-your-topic__grid {
      grid-template-columns: repeat(3, 1fr);
    }

    .choose-your-topic__panel-title {
      font-size: 36px;
    }
  }
</style>

<script>
  (function() {
    'use strict';
    
    class ChooseYourTopic {
      constructor(section) {
        this.section = section;
        this.tabs = section.querySelectorAll('[role="tab"]');
        this.panels = section.querySelectorAll('[role="tabpanel"]');
        this.searchInput = section.querySelector('[data-search="input"]');
        this.searchClear = section.querySelector('[data-search="clear"]');
        this.filterSelect = section.querySelector('[data-filter="category"]');
        this.activePanel = null;
        this.searchTimeout = null;
        
        this.init();
      }
      
      init() {
        // Tab switching
        this.tabs.forEach(tab => {
          tab.addEventListener('click', (e) => this.handleTabClick(e));
        });
        
        // Search with debounce
        if (this.searchInput) {
          this.searchInput.addEventListener('input', (e) => this.handleSearch(e));
        }
        
        if (this.searchClear) {
          this.searchClear.addEventListener('click', () => this.clearSearch());
        }
        
        // Filter select
        if (this.filterSelect) {
          this.filterSelect.addEventListener('change', (e) => this.handleFilter(e));
        }
        
        // Initialize active panel
        this.setActivePanel(this.section.querySelector('[role="tabpanel"].choose-your-topic__panel--active'));
      }
      
      handleTabClick(e) {
        const tab = e.currentTarget;
        const panelId = tab.getAttribute('aria-controls');
        const panel = this.section.querySelector(`#${panelId}`);
        
        if (!panel) return;
        
        // Update tabs
        this.tabs.forEach(t => {
          t.classList.remove('choose-your-topic__tab--active');
          t.setAttribute('aria-selected', 'false');
        });
        tab.classList.add('choose-your-topic__tab--active');
        tab.setAttribute('aria-selected', 'true');
        
        // Update panels
        this.panels.forEach(p => {
          p.classList.remove('choose-your-topic__panel--active');
        });
        panel.classList.add('choose-your-topic__panel--active');
        
        // Set active panel
        this.setActivePanel(panel);
        
        // Reset filters
        this.resetFilters();
      }
      
      setActivePanel(panel) {
        this.activePanel = panel;
        
        if (!panel) return;
        
        // Populate filter select with tags from active blog
        if (this.filterSelect) {
          const tagsData = panel.querySelector('[data-blog-tags]');
          if (tagsData) {
            try {
              const tags = JSON.parse(tagsData.textContent);
              this.populateFilterSelect(tags);
            } catch (e) {
              console.error('Error parsing tags:', e);
            }
          } else {
            this.filterSelect.innerHTML = '<option value="">All categories</option>';
          }
        }
        
      }
      
      populateFilterSelect(tags) {
        if (!this.filterSelect) return;
        
        this.filterSelect.innerHTML = '<option value="">All categories</option>';
        
        tags.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag.toLowerCase();
          option.textContent = tag;
          this.filterSelect.appendChild(option);
        });
      }
      
      handleSearch(e) {
        clearTimeout(this.searchTimeout);
        
        this.searchTimeout = setTimeout(() => {
          const query = e.target.value.toLowerCase().trim();
          this.filterArticles(query, this.filterSelect?.value || '');
          
          // Show/hide clear button
          if (this.searchClear) {
            this.searchClear.style.display = query ? 'flex' : 'none';
          }
        }, 300);
      }
      
      handleFilter(e) {
        const category = e.target.value;
        const searchQuery = this.searchInput?.value.toLowerCase().trim() || '';
        this.filterArticles(searchQuery, category);
      }
      
      filterArticles(searchQuery, category) {
        if (!this.activePanel) return;
        
        const articles = this.activePanel.querySelectorAll('[data-article-id]');
        const emptyState = this.activePanel.querySelector('.choose-your-topic__empty');
        let visibleCount = 0;
        
        articles.forEach(article => {
          const title = article.getAttribute('data-article-title') || '';
          const excerpt = article.getAttribute('data-article-excerpt') || '';
          const tags = article.getAttribute('data-article-tags') || '';
          
          const matchesSearch = !searchQuery || 
            title.includes(searchQuery) || 
            excerpt.includes(searchQuery);
          
          const matchesCategory = !category || 
            tags.split(',').includes(category);
          
          if (matchesSearch && matchesCategory) {
            article.classList.remove('choose-your-topic__article-item--filtered');
            article.style.display = '';
            visibleCount++;
          } else {
            article.classList.add('choose-your-topic__article-item--filtered');
            article.style.display = 'none';
          }
        });
        
        // Show/hide empty state
        if (emptyState) {
          emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
        }
      }
      
      clearSearch() {
        if (this.searchInput) {
          this.searchInput.value = '';
          this.searchInput.dispatchEvent(new Event('input'));
        }
        if (this.searchClear) {
          this.searchClear.style.display = 'none';
        }
      }
      
      resetFilters() {
        if (this.searchInput) {
          this.searchInput.value = '';
        }
        if (this.searchClear) {
          this.searchClear.style.display = 'none';
        }
        if (this.filterSelect) {
          this.filterSelect.value = '';
        }
        
        // Show all articles in active panel
        if (this.activePanel) {
          const articles = this.activePanel.querySelectorAll('[data-article-id]');
          articles.forEach(article => {
            article.classList.remove('choose-your-topic__article-item--filtered');
            article.style.display = '';
          });
          
          const emptyState = this.activePanel.querySelector('.choose-your-topic__empty');
          if (emptyState && articles.length > 0) {
            emptyState.style.display = 'none';
          }
        }
      }
      
      handleLoadMore() {
        if (!this.activePanel) return;
        
        const container = this.activePanel.querySelector('[data-articles-container]');
        if (!container) return;
        
        const loadMoreCount = parseInt(container.getAttribute('data-load-more-count')) || 6;
        const hiddenArticles = this.activePanel.querySelectorAll(
          '.choose-your-topic__article-item--hidden:not(.choose-your-topic__article-item--filtered)'
        );
        
        let loaded = 0;
        hiddenArticles.forEach(article => {
          if (loaded < loadMoreCount) {
            article.classList.remove('choose-your-topic__article-item--hidden');
            article.style.display = '';
            loaded++;
          }
        });
        
      }
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const sections = document.querySelectorAll('[data-section-type="choose-your-topic"]');
      sections.forEach(section => {
        new ChooseYourTopic(section);
      });
    });
    
    // Reinitialize when section is loaded in theme editor
    document.addEventListener('shopify:section:load', (event) => {
      const section = event.target.querySelector('[data-section-type="choose-your-topic"]');
      if (section) {
        new ChooseYourTopic(section);
      }
    });
  })();
</script>

{% schema %}
  {
    "name": "Choose Your Topic",
    "settings": [
      {
        "type": "text",
        "id": "title",
        "label": "Section Title",
        "default": "Choose your topic"
      },
      {
        "type": "header",
        "content": "Filters"
      }, {
        "type": "checkbox",
        "id": "show_search",
        "label": "Show Search",
        "default": true
      }, {
        "type": "checkbox",
        "id": "show_filter",
        "label": "Show Category Filter",
        "default": true
      }, {
        "type": "header",
        "content": "Spacing"
      }, {
        "type": "range",
        "id": "padding_top",
        "label": "Top Padding",
        "min": 0,
        "max": 120,
        "step": 10,
        "default": 60,
        "unit": "px"
      }, {
        "type": "range",
        "id": "padding_bottom",
        "label": "Bottom Padding",
        "min": 0,
        "max": 120,
        "step": 10,
        "default": 60,
        "unit": "px"
      }, {
        "type": "header",
        "content": "Colors"
      }, {
        "type": "color",
        "id": "section_bg",
        "label": "Section Background",
        "info": "Leave empty to use default color"
      }
    ],
    "blocks": [
      {
        "type": "blog_tab",
        "name": "Blog Tab",
        "settings": [
          {
            "type": "text",
            "id": "tab_label",
            "label": "Tab Label",
            "default": "Tab"
          }, {
            "type": "blog",
            "id": "blog",
            "label": "Blog",
            "info": "Select the blog for this tab"
          }, {
            "type": "checkbox",
            "id": "default_active",
            "label": "Set as Default Active Tab",
            "default": false,
            "info": "Only one tab should be marked as active"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Choose Your Topic",
        "blocks": [
          {
            "type": "blog_tab",
            "settings": {
              "tab_label": "Customer Stories",
              "default_active": true
            }
          },
          {
            "type": "blog_tab",
            "settings": {
              "tab_label": "Organizational Wellness"
            }
          },
          {
            "type": "blog_tab",
            "settings": {
              "tab_label": "Personal Wellness"
            }
          },
          {
            "type": "blog_tab",
            "settings": {
              "tab_label": "Wellhub News"
            }
          }, {
            "type": "blog_tab",
            "settings": {
              "tab_label": "Wellness Partners"
            }
          }
        ]
      }
    ]
  }
{% endschema %}