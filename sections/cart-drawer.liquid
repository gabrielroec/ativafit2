{% comment %} 
      Cart Drawer Section - Shopify 2.0
       
      Seguindo as best practices oficiais da Shopify: 
      - Usa form 'cart' nativo para payment_terms funcionar 
      - AcessÃ­vel (ARIA, keyboard navigation) 
      - Performance otimizada
       
      ReferÃªncias: 
      - https://shopify.dev/docs/storefronts/themes/pricing-payments/installments 
      - https://shopify.dev/docs/storefronts/themes/best-practices 
{% endcomment %}

{{ 'cart-drawer-new.css' | asset_url | stylesheet_tag }}

<cart-drawer class="cart-drawer {% if cart.item_count == 0 %}is-empty{% endif %}">
  <div
    id="CartDrawer"
    class="cart-drawer__container"
    role="dialog"
    aria-modal="true"
    aria-label="Shopping Cart"
    tabindex="-1">

    {%- comment -%} Drawer Content {%- endcomment -%}
    <div class="cart-drawer__content">

      {%- comment -%} Header {%- endcomment -%}
      <div class="cart-drawer__header">
        <div class="cart-drawer__header-left">
          <h2 class="cart-drawer__title">{{ section.settings.heading | default: 'Your Cart' }}</h2>
          <button 
            class="cart-drawer__loyalty-btn" 
            aria-label="Member Discount"
            type="button"
            data-open-loyalty>
            <svg width="20" height="20" viewBox="0 0 37 34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M33.5561 9.01065H27.7105C27.8733 8.87444 28.0156 8.74502 28.1445 8.61561C30.0229 6.71532 30.0229 3.62309 28.1445 1.7228C27.2698 0.837358 26.022 0.333344 24.7199 0.333344C23.418 0.333344 22.1702 0.837358 21.2954 1.7228C20.7801 2.24044 19.8985 3.49368 19.2068 4.88995C18.8405 5.63235 18.5557 6.3339 18.3659 6.99457C18.1761 6.3339 17.8913 5.63235 17.525 4.88995C16.8333 3.49368 15.945 2.24044 15.4364 1.7228C14.5616 0.837358 13.3138 0.333344 12.0118 0.333344C10.7098 0.333344 9.46208 0.837358 8.5873 1.7228C6.70887 3.62309 6.70887 6.71532 8.5873 8.61561C8.70935 8.73822 8.85854 8.87444 9.02129 9.01065H3.17582C1.79244 9.01065 0.666748 10.1413 0.666748 11.5308V16.9796C0.666748 17.7697 1.30419 18.41 2.09082 18.41H2.83675V31.1466C2.83675 32.5361 3.96245 33.6667 5.34583 33.6667H31.386C32.7693 33.6667 33.895 32.5361 33.895 31.1466V18.41H34.641C35.4276 18.41 36.0651 17.7697 36.0651 16.9796V11.5308C36.0651 10.1413 34.9394 9.01065 33.5561 9.01065ZM31.0469 18.41V30.8061H19.7899V18.41H31.0469ZM24.7199 3.17356C25.2557 3.17356 25.7643 3.37789 26.1237 3.73888C26.9035 4.52897 26.9035 5.80945 26.1237 6.59954C25.2286 7.50541 22.4889 9.01065 21.0649 9.01065C20.9902 9.01065 20.936 9.00385 20.902 9.00385C20.8749 8.79951 20.9495 8.10478 21.4447 6.87879C21.9736 5.57787 22.6855 4.37912 23.3162 3.7457C23.6689 3.37789 24.1842 3.17356 24.7199 3.17356ZM33.217 11.8713V15.5492H19.7899V11.8713H33.217ZM16.9419 18.41V30.8061H5.6849V18.41H16.9419ZM10.6081 3.73888C10.9811 3.35747 11.4829 3.15313 12.0118 3.15313C12.5408 3.15313 13.0358 3.36427 13.4156 3.73888C14.0462 4.37231 14.7583 5.57106 15.2872 6.87197C15.7823 8.09796 15.8569 8.7927 15.8298 8.99704C15.7958 9.00385 15.7416 9.00385 15.6669 9.00385C14.2429 9.00385 11.51 7.4986 10.6081 6.59273C9.82826 5.80945 9.82826 4.52897 10.6081 3.73888ZM16.9419 11.8713V15.5492H3.51488V11.8713H16.9419Z" fill="#ffffff"></path>
            </svg>
            <span>10% Off for members</span>
          </button>
        </div>
        <button
          class="cart-drawer__close"
          type="button"
          aria-label="Close cart"
          data-close-drawer>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round">
            <line
              x1="18"
              y1="6"
              x2="6"
              y2="18"></line>
            <line
              x1="6"
              y1="6"
              x2="18"
              y2="18"></line>
          </svg>
        </button>
      </div>

      {%- comment -%} Free Shipping Bar (US only) {%- endcomment -%}
      {%- assign country_code = localization.country.iso_code | upcase -%}
      {%- if section.settings.show_free_shipping_bar and country_code == 'US' and section.settings.free_shipping_threshold > 0 -%}
        {%- assign threshold_cents = section.settings.free_shipping_threshold | times: 100 -%}
        {%- assign remaining_cents = threshold_cents | minus: cart.total_price -%}
        {%- assign remaining_money = remaining_cents | money -%}
        {%- assign progress = cart.total_price | times: 100 | divided_by: threshold_cents -%}
        {%- if progress > 100 -%}
          {%- assign progress = 100 -%}
        {%- endif -%}
        <div class="cart-drawer__free-shipping" role="status" aria-live="polite">
          <div class="cart-drawer__free-shipping-text">
            <span class="cart-drawer__free-shipping-emoji" aria-hidden="true">ðŸšš</span>
            {%- if remaining_cents > 0 -%}
              {{ section.settings.free_shipping_progress_text | replace: '[amount]', remaining_money }}
            {%- else -%}
              {{ section.settings.free_shipping_unlocked_text }}
            {%- endif -%}
          </div>
          <div class="cart-drawer__free-shipping-bar" aria-hidden="true">
            <span class="cart-drawer__free-shipping-fill" style="width: {{ progress }}%;"></span>
          </div>
        </div>
      {%- endif -%}

      {%- comment -%} Cart Items {%- endcomment -%}
      <div
        class="cart-drawer__items"
        id="CartDrawer-Items"
        data-id="{{ section.id }}">
        {% render 'cart-drawer-items' %}
      </div>

      {%- comment -%} Footer with Cart Form {%- endcomment -%}
      <div class="cart-drawer__footer">
        {% form 'cart'
          , cart
          , id: 'CartDrawer-Form'
          , class: 'cart-drawer__form' %}

          {%- comment -%} Recommended Products {%- endcomment -%}
          {%- if section.settings.show_recommendations and cart.item_count > 0 -%}
            <div class="cart-drawer__recommendations" id="CartDrawer-Recommendations">
              {% render 'cart-drawer-recommendations' %}
            </div>
        {%- endif -%}

          {%- comment -%} Subtotal with Discount Info {%- endcomment -%}
          {%- assign total_savings = 0 -%}
          {%- assign has_total_discount = false -%}

          {%- comment -%} Calculate total savings from items {%- endcomment -%}
          {%- for item in cart.items -%}
            {%- if item.variant.compare_at_price and item.variant.compare_at_price > item.price -%}
              {%- assign per_unit_savings = item.variant.compare_at_price | minus: item.price -%}
              {%- assign total_savings = total_savings | plus: per_unit_savings | times: item.quantity -%}
              {%- assign has_total_discount = true -%}
            {%- elsif item.original_line_price > item.final_line_price -%}
              {%- assign item_savings = item.original_line_price | minus: item.final_line_price -%}
              {%- assign total_savings = total_savings | plus: item_savings -%}
              {%- assign has_total_discount = true -%}
            {%- endif -%}
          {%- endfor -%}

          {%- comment -%} Add cart-level discounts {%- endcomment -%}
          {%- if cart.cart_level_discount_applications.size > 0 -%}
            {%- assign has_total_discount = true -%}
            {%- for discount in cart.cart_level_discount_applications -%}
              {%- assign total_savings = total_savings | plus: discount.total_allocated_amount -%}
            {%- endfor -%}
        {%- endif -%}

          {%- comment -%} Calculate original total price {%- endcomment -%}
          {%- assign original_total = cart.total_price | plus: total_savings -%}

          <div class="cart-drawer__subtotal">
            <span class="cart-drawer__subtotal-label">{{ section.settings.subtotal_label | default: 'Subtotal' }}</span>
            {%- if has_total_discount and total_savings > 0 -%}
              <div class="cart-drawer__subtotal-savings-badge">
                You save {{ total_savings | money }}
              </div>
            {%- endif -%}
            <span class="cart-drawer__subtotal-price" data-cart-subtotal>
              {{ cart.total_price | money_with_currency }}
            </span>
            {%- if has_total_discount and original_total > cart.total_price -%}
              <span class="cart-drawer__subtotal-original-price">
                {{ original_total | money_with_currency }}
              </span>
            {%- endif -%}
          </div>

          {%- comment -%} Shop Pay Installments - Official {%- endcomment -%}
          {% if section.settings.show_payment_terms %}
            <div class="cart-drawer__payment-terms">
              {{ form | payment_terms }}
            </div>
          {% endif %}

          {%- comment -%} Shipping Notice {%- endcomment -%}
          {% if section.settings.shipping_notice != blank %}
            <div class="cart-drawer__notice">
              {{ section.settings.shipping_notice }}
            </div>
          {% endif %}

          {%- comment -%} Cart Actions {%- endcomment -%}
          <div class="cart-drawer__actions">
            <button
              type="submit"
              class="cart-drawer__checkout button button--primary"
              name="checkout">
              {{ section.settings.checkout_button_label | default: 'Checkout' }}
            </button>

            {%- comment -%} Payment Badges {%- endcomment -%}
            {% if section.settings.show_payment_badges %}
              <div class="cart-drawer__payment-badges">
                <img
                  src="https://download.logo.wine/logo/Mastercard/Mastercard-Logo.wine.png"
                  alt="Mastercard"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/9/93/PayPal_Logo2014.png"
                  alt="PayPal"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
                <img
                  src="https://cdn.shopify.com/shopifycloud/help-center/manual/shop-pay-installments/shop-pay-logo-color.png"
                  alt="Shop Pay"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/d/de/Amazon_icon.png"
                  alt="Amazon Pay"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
                <img
                  src="https://cdn-icons-png.freepik.com/256/5968/5968245.png?semt=ais_white_label"
                  alt="American Express"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
                <img
                  src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQfp_3jN-zgVDJzWjr1I4lKWWRothBbWHb8hQ&s"
                  alt="Apple Pay"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
                <img
                  src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSECDKIpkdSUbFaBLjhaAxj0qMcSdLRFvvtvQ&s"
                  alt="Diners Club"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Google_Pay_Logo.svg/1280px-Google_Pay_Logo.svg.png"
                  alt="Google Pay"
                  class="payment-badge"
                  loading="lazy"
                  width="40"
                  height="24">
              </div>
            {% endif %}
          </div>

          {%- comment -%} Additional Checkout Buttons (Apple Pay, Google Pay, etc) {%- endcomment -%}
          {%- comment -%}
          {% if additional_checkout_buttons and section.settings.show_dynamic_checkout %}
            <div class="cart-drawer__dynamic-checkout">
              {{ content_for_additional_checkout_buttons }}
            </div>
          {% endif %}
          {%- endcomment -%}

        {% endform %}
      </div>

    </div>
  </div>
</cart-drawer>

<script src="{{ 'cart-drawer-new.js' | asset_url }}" defer="defer"></script>

{% schema %}
  {
    "name": "Cart Drawer",
    "settings": [
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "Your Cart"
      },
      {
        "type": "text",
        "id": "subtotal_label",
        "label": "Subtotal Label",
        "default": "Subtotal"
      },
      {
        "type": "text",
        "id": "checkout_button_label",
        "label": "Checkout Button Label",
        "default": "Checkout"
      },
      {
        "type": "checkbox",
        "id": "show_payment_terms",
        "label": "Show Shop Pay Installments",
        "default": true,
        "info": "Displays Shop Pay Installments banner if available"
      },
      {
        "type": "checkbox",
        "id": "show_recommendations",
        "label": "Show Recommended Products",
        "default": true,
        "info": "Displays one recommended product above subtotal"
      },
      {
        "type": "checkbox",
        "id": "show_dynamic_checkout",
        "label": "Show Dynamic Checkout Buttons",
        "default": true,
        "info": "Shows Apple Pay, Google Pay, etc"
      },
      {
        "type": "checkbox",
        "id": "show_free_shipping_bar",
        "label": "Show Free Shipping Bar (US only)",
        "default": true
      },
      {
        "type": "number",
        "id": "free_shipping_threshold",
        "label": "Free Shipping Threshold (USD)",
        "default": 50
      },
      {
        "type": "text",
        "id": "free_shipping_progress_text",
        "label": "Progress Text",
        "default": "Add [amount] more for free shipping in the U.S."
      },
      {
        "type": "text",
        "id": "free_shipping_unlocked_text",
        "label": "Unlocked Text",
        "default": "You unlocked free shipping in the U.S.!"
      },
      {
        "type": "richtext",
        "id": "shipping_notice",
        "label": "Shipping Notice",
        "info": "Display shipping information (e.g., 'Free shipping on orders over $50')"
      },
      {
        "type": "checkbox",
        "id": "show_payment_badges",
        "label": "Show Payment Method Badges",
        "default": true,
        "info": "Display accepted payment method icons"
      }
    ],
    "presets": [
      {
        "name": "Cart Drawer"
      }
    ]
  }
{% endschema %}