{%- liquid
  assign section_id = 'ImageTabs-' | append: section.id
  assign first_block_id = section.blocks.first.id
-%}

<section id="{{ section_id }}" class="image-tabs">
  <div class="image-tabs__container">
    <div class="image-tabs__grid">
      <div class="image-tabs__media">
        {%- if section.settings.image != blank -%}
          {{
            section.settings.image
            | image_url: width: 1400
            | image_tag:
              loading: 'lazy',
              widths: '600, 800, 1000, 1200, 1400',
              sizes: '(min-width: 990px) 50vw, 100vw',
              alt: section.settings.image_alt | default: section.settings.image.alt | escape
          }}
        {%- else -%}
          {{ 'image' | placeholder_svg_tag: 'image-tabs__placeholder' }}
        {%- endif -%}
      </div>

      <div class="image-tabs__content">
        {%- if section.blocks.size > 0 -%}
          <div class="image-tabs__tabs" role="tablist" aria-label="Content tabs">
            {%- for block in section.blocks -%}
              {%- if block.id == first_block_id -%}
                {%- assign is_active = true -%}
              {%- else -%}
                {%- assign is_active = false -%}
              {%- endif -%}
              <button
                class="image-tabs__tab{% if is_active %} is-active{% endif %}"
                type="button"
                role="tab"
                aria-selected="{% if is_active %}true{% else %}false{% endif %}"
                aria-controls="{{ section_id }}-panel-{{ block.id }}"
                id="{{ section_id }}-tab-{{ block.id }}"
                data-tab="{{ block.id }}"
                {{ block.shopify_attributes }}
              >
                {{ block.settings.title | escape }}
              </button>
            {%- endfor -%}
          </div>

          <div class="image-tabs__panels">
            {%- for block in section.blocks -%}
              {%- if block.id == first_block_id -%}
                {%- assign is_active = true -%}
              {%- else -%}
                {%- assign is_active = false -%}
              {%- endif -%}
              <div
                class="image-tabs__panel{% if is_active %} is-active{% endif %}"
                role="tabpanel"
                id="{{ section_id }}-panel-{{ block.id }}"
                aria-labelledby="{{ section_id }}-tab-{{ block.id }}"
                data-panel="{{ block.id }}"
                {% unless is_active %}hidden{% endunless %}
              >
                <div class="image-tabs__panel-text">
                  {{ block.settings.text }}
                </div>
              </div>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</section>

<style>
  #{{ section_id }} {
    padding-top: {{ section.settings.padding_top | default: 24 }}px;
    padding-bottom: {{ section.settings.padding_bottom | default: 24 }}px;
  }
  #{{ section_id }} .image-tabs__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 16px;
  }
  #{{ section_id }} .image-tabs__grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 32px;
    align-items: start;
  }
  #{{ section_id }} .image-tabs__media img,
  #{{ section_id }} .image-tabs__media svg {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 12px;
  }
  #{{ section_id }} .image-tabs__tabs {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    white-space: nowrap;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 16px;
    touch-action: pan-y;
    cursor: grab;
    user-select: none;
  }
  #{{ section_id }} .image-tabs__tabs.is-dragging {
    cursor: grabbing;
  }
  #{{ section_id }} .image-tabs__tabs::-webkit-scrollbar {
    height: 6px;
  }
  #{{ section_id }} .image-tabs__tabs::-webkit-scrollbar-thumb {
    background: #d9d9d9;
    border-radius: 999px;
  }
  #{{ section_id }} .image-tabs__tab {
    appearance: none;
    border: none;
    background: transparent;
    color: #b5b5b5;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 4px 0 8px;
    border-bottom: 2px solid transparent;
    flex: 0 0 auto;
    scroll-snap-align: start;
  }
  #{{ section_id }} .image-tabs__tab.is-active {
    color: #000000;
    border-bottom-color: #000000;
  }
  #{{ section_id }} .image-tabs__panel-text {
    font-size: 14px;
    color: #333333;
  }
  @media (max-width: 749px) {
    #{{ section_id }} .image-tabs__grid {
      grid-template-columns: minmax(0, 1fr);
      gap: 20px;
    }
  }
</style>

<script defer>
  (function () {
    var section = document.getElementById('{{ section_id }}');
    if (!section) return;

    var tabs = section.querySelectorAll('[data-tab]');
    var panels = section.querySelectorAll('[data-panel]');
    if (!tabs.length || !panels.length) return;

    var tabList = section.querySelector('.image-tabs__tabs');
    var tabList = section.querySelector('.image-tabs__tabs');
    var isDragging = false;
    var dragMoved = false;
    var startX = 0;
    var scrollLeft = 0;
    var dragThreshold = 6;

    if (tabList) {
      tabList.addEventListener('pointerdown', function (event) {
        if (event.button !== 0) return;
        isDragging = true;
        dragMoved = false;
        startX = event.clientX;
        scrollLeft = tabList.scrollLeft;
        tabList.classList.add('is-dragging');
        tabList.setPointerCapture(event.pointerId);
      });

      tabList.addEventListener('pointermove', function (event) {
        if (!isDragging) return;
        var delta = event.clientX - startX;
        if (Math.abs(delta) > dragThreshold) dragMoved = true;
        tabList.scrollLeft = scrollLeft - delta;
      });

      function stopDrag(event) {
        if (!isDragging) return;
        isDragging = false;
        tabList.classList.remove('is-dragging');
        if (event && event.pointerId) {
          tabList.releasePointerCapture(event.pointerId);
        }
      }

      tabList.addEventListener('pointerup', stopDrag);
      tabList.addEventListener('pointercancel', stopDrag);
      tabList.addEventListener('pointerleave', stopDrag);
    }

    function activateTab(tabId) {
      tabs.forEach(function (tab) {
        var isActive = tab.getAttribute('data-tab') === tabId;
        tab.classList.toggle('is-active', isActive);
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      panels.forEach(function (panel) {
        var isActive = panel.getAttribute('data-panel') === tabId;
        panel.classList.toggle('is-active', isActive);
        if (isActive) {
          panel.removeAttribute('hidden');
        } else {
          panel.setAttribute('hidden', '');
        }
      });
    }

    section.addEventListener('click', function (event) {
      if (dragMoved) return;
      var button = event.target.closest('[data-tab]');
      if (!button || !section.contains(button)) return;
      activateTab(button.getAttribute('data-tab'));
    });
  })();
</script>

{% schema %}
{
  "name": "Image Tabs",
  "settings": [
    {
      "type": "image_picker",
      "id": "image",
      "label": "Left image"
    },
    {
      "type": "text",
      "id": "image_alt",
      "label": "Left image alt text",
      "default": "Lifestyle image"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top (px)",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom (px)",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 24
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Tab title",
          "default": "Tab title"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Tab text",
          "default": "<p>Use this text area to describe the tab content.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image Tabs",
      "blocks": [
        { "type": "tab" },
        { "type": "tab" },
        { "type": "tab" }
      ]
    }
  ]
}
{% endschema %}
