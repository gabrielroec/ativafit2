{% comment %} 
                        Product Add to Cart Component
                         
                        Renders variant selector, add to cart button, and Shopify native helpers:
                        - Dynamic checkout buttons (Shop Pay, Apple Pay, Google Pay)
                        - Payment terms (Shop Pay Installments)
                         
                        Accepts: 
                        - product: {Object} Product object 
                        - section: {Object} Section object for settings
                         
                        Usage:
                        {% render 'product-add-to-cart', product: product, section: section %} 
{% endcomment %}

{%- assign selected_variant = product.selected_or_first_available_variant -%}
{%- assign product_form_id = 'product-form-' | append: section.id -%}
{%- assign payment_options_block = section.blocks | where: 'type', 'payment_options' | first -%}

{%- comment -%} Check if waitlist should be shown for current variant {%- endcomment -%}
{%- assign should_show_waitlist = false -%}
{%- if section.settings.show_waitlist_button -%}
  {%- if section.settings.waitlist_variant_ids == blank or section.settings.waitlist_variant_ids == '' -%}
    {%- comment -%} No variant IDs specified, show for all variants {%- endcomment -%}
    {%- assign should_show_waitlist = true -%}
  {%- else -%}
    {%- comment -%} Check if current variant ID or name is in the list {%- endcomment -%}
    {%- assign selected_variant_id_string = selected_variant.id | append: '' -%}
    {%- assign selected_variant_title = selected_variant.title | strip | downcase -%}
    {%- assign variant_list = section.settings.waitlist_variant_ids | split: ',' -%}
    {%- for variant_item in variant_list -%}
      {%- assign variant_item_trimmed = variant_item | strip -%}
      {%- assign variant_item_lower = variant_item_trimmed | downcase -%}
      {%- comment -%} Check by ID (exact match, case-sensitive) or by name (case-insensitive) {%- endcomment -%}
      {%- if variant_item_trimmed == selected_variant_id_string or variant_item_lower == selected_variant_title -%}
        {%- assign should_show_waitlist = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endif -%}

  {%- form 'product'
    , product
    , id: product_form_id
    , class: 'product-form_new' -%}
  <!-- Hidden variant input (updated dynamically) -->
  <input
    type="hidden"
    name="id"
    value="{{ selected_variant.id }}"
    id="product-variant-id-{{ section.id }}">

  <!-- Payment Terms (Shop Pay Installments) - Before buttons -->
  {%- if payment_options_block and payment_options_block.settings.show_payment_terms -%}
    <div class="payment-options-form">
      {{ form | payment_terms }}
    </div>
  {%- endif -%}

  <!-- Variant Selector + Add to Cart Button Container -->
  {%- comment -%} Show content if variant is available OR if waitlist is active (even if sold out) {%- endcomment -%}
  {%- if selected_variant.available or should_show_waitlist -%}
    <div class="variant-cart-row_new">
      <!-- Variant Selector (if product has multiple variants) - Desktop only -->
      {%- if product.variants.size > 1 and section.settings.show_variant_selector -%}
        <div class="variant-selector-wrapper_new variant-selector-desktop_new">
          <label for="variant-selector_new">{{ section.settings.variant_label | default: "Select Option" }}</label>
          <select
            id="variant-selector_new"
            class="variant-selector_new variant-selector-desktop_new"
            name="id"
            onchange="updateVariant()">
            {%- for variant in product.variants -%}
              <option
                value="{{ variant.id }}"
                {% if variant == selected_variant %}
                selected{% endif %}
                {% unless variant.available %}
                disabled{% endunless %}>
                {{ variant.title }}
                {%- unless variant.available %}
                  - Sold Out{% endunless -%}
              </option>
            {%- endfor -%}
          </select>
        </div>
      {%- endif -%}

      <!-- Waitlist Button and Add to Cart Button (both rendered, JS controls visibility) -->
      {%- comment -%} Debug: show_waitlist_button={{ section.settings.show_waitlist_button }}, waitlist_variant_ids={{ section.settings.waitlist_variant_ids }}, selected_variant.title={{ selected_variant.title }}, selected_variant.id={{ selected_variant.id }}, should_show_waitlist={{ should_show_waitlist }} {%- endcomment -%}
      {%- if section.settings.show_waitlist_button -%}
        {%- comment -%} Render waitlist button (hidden by default if variant doesn't match) {%- endcomment -%}
        <button
          type="button"
          class="add-to-cart-btn_new waitlist-btn_new klaviyo_waitlist_trigger {% if product.variants.size > 1 and section.settings.show_variant_selector %}has-variant-selector_new{% endif %}"
          data-klaviyo-form-id="{{ section.settings.klaviyo_form_id | escape }}"
          data-variant-id="{{ selected_variant.id }}"
          style="{% unless should_show_waitlist %}display: none;{% endunless %}"
          aria-label="{{ section.settings.waitlist_button_text | default: 'Join the Waitlist' }}">
          {{ section.settings.waitlist_button_text | default: 'Join the Waitlist' }}
        </button>
      {%- endif -%}
      {%- comment -%} Render add to cart button (hidden if waitlist is active for this variant OR if variant is not available) {%- endcomment -%}
      <button
        type="submit"
        name="add"
        class="add-to-cart-btn_new {% if product.variants.size > 1 and section.settings.show_variant_selector %}has-variant-selector_new{% endif %}"
        data-variant-id="{{ selected_variant.id }}"
        style="{% if section.settings.show_waitlist_button and should_show_waitlist or selected_variant.available == false %}display: none;{% endif %}"
        aria-label="{{ section.settings.add_to_cart_text | default: 'Add to cart' }}">
        {{ section.settings.add_to_cart_text | default: 'Add to Cart' }}
      </button>
    </div>

    <!-- Buy It Now Button (hidden when waitlist is active for current variant OR when variant is not available) -->
    {%- if section.settings.show_buy_it_now and should_show_waitlist == false and selected_variant.available -%}
      <button
        type="button"
        class="buy-it-now-btn_new"
        onclick="buyItNow()"
        aria-label="{{ section.settings.buy_it_now_text | default: 'Buy It Now' }}">
        {{ section.settings.buy_it_now_text | default: 'Buy It Now' }}
      </button>
    {%- endif -%}

    <!-- Dynamic Checkout Buttons (Shop Pay, Apple Pay, Google Pay) - Third -->
    {%- comment -%} Only show dynamic checkout if variant is available (not when waitlist is active) {%- endcomment -%}
    {%- if payment_options_block and payment_options_block.settings.show_dynamic_checkout and selected_variant.available -%}
      <div
        id="dynamic-checkout-{{ section.id }}"
        {% if section.settings.remove_shop_pay_button %}
        class="hide-shop-pay_new"
        {% endif %}>
        {{ form | payment_button }}
      </div>
    {%- endif -%}
  {%- else -%}
    {%- comment -%} Only show "Sold Out" button if waitlist is NOT active {%- endcomment -%}
    <button
      type="button"
      class="add-to-cart-btn_new"
      disabled
      aria-label="Sold out">
      Sold Out
    </button>
  {%- endif -%}
{%- endform -%}

<!-- Payment Icons (Accepted Payment Methods) - Shown if enabled -->
{%- if payment_options_block and payment_options_block.settings.show_payment_icons -%}
  <div class="payment-icons_new">
    <img
      src="https://www.ativafit.com/cdn/shop/files/bank_e49b0ef7-0b7d-46e6-b59d-f28b627ed7a3_1024x1024.png?v=1707126791"
      alt="Accepted payment methods"
      class="payment-icons__static-image_new"
      width="1024"
      height="1024"
      loading="lazy">
  </div>
{%- endif -%}

<!-- Payment Text (if enabled) -->
{%- if payment_options_block and payment_options_block.settings.payment_text != blank -%}
  <div class="payment-text_new">
    {{ payment_options_block.settings.payment_text }}
  </div>
{%- endif -%}

<!-- AtivaPeople CTA (if enabled) -->
{%- if section.settings.show_ativapeople_cta -%}
  <p class="ativapeople-cta_new">
    {{ section.settings.ativapeople_cta_text }}
  </p>
{%- endif -%}