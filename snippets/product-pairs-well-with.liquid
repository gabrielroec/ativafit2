{% comment %} 
                                    Product Pairs Well With Component
                                     
                                    Renders a carousel of related/complementary products (up to 5 products).
                                     
                                    Accepts: 
                                    - section: {Object} Section object for settings
                                     
                                    Usage:
                                    {% render 'product-pairs-well-with', section: section %} 
{% endcomment %}

{%- if section.settings.show_pairs_well_with -%}
  <div class="pairs-well-with_new" id="pairs-well-with-{{ section.id }}">
    {%- if section.settings.pairs_well_with_title != blank -%}
      <h2 class="pairs-well-with-title_new">{{ section.settings.pairs_well_with_title }}</h2>
    {%- endif -%}

    <div class="pairs-well-with-slider_new">
      {%- assign product_count = 0 -%}

      {%- comment -%} Count products from blocks {%- endcomment -%}
      {%- for block in section.blocks -%}
        {%- if block.type == 'pairs_well_with_product' and block.settings.product != blank -%}
          {%- assign selected_product = all_products[block.settings.product] -%}
          {%- if selected_product != blank -%}
            {%- assign product_count = product_count | plus: 1 -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if product_count > 0 -%}
        <div class="pairs-well-with-container_new" tabindex="0">
          {%- assign slide_index = 0 -%}
          {%- assign is_first_product = true -%}

          {%- comment -%} Render products from blocks {%- endcomment -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'pairs_well_with_product' and block.settings.product != blank -%}
              {%- assign slide_product = all_products[block.settings.product] -%}
              {%- if slide_product != blank -%}
                {%- render 'pairs-well-with-slide'
                  , product: slide_product
                  , section: section
                  , slide_index: slide_index
                  , is_first: is_first_product -%}
                {%- assign slide_index = slide_index | plus: 1 -%}
                {%- assign is_first_product = false -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>

        {%- comment -%} Navigation dots {%- endcomment -%}
        {%- if product_count > 1 -%}
          <div class="pairs-well-with-dots_new" id="pairs-well-with-dots-{{ section.id }}">
            {%- for i in (1..product_count) -%}
              <button
                type="button"
                class="pairs-well-with-dot_new {% if forloop.first %}active_new{% endif %}"
                data-slide-index="{{ forloop.index0 }}"
                aria-label="Go to slide {{ forloop.index }}"></button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      {%- endif -%}
    </div>
  </div>

  <script>
    (function() {
      const sliderId = 'pairs-well-with-{{ section.id }}';
      const slider = document.querySelector(`#${sliderId}`);
      const container = slider?.querySelector('.pairs-well-with-container_new');
      const slides = container?.querySelectorAll('.pairs-well-with-slide_new');
      const dots = slider?.querySelectorAll('.pairs-well-with-dot_new');
      
      if (!container || !slider || !slides || slides.length <= 1) return;
      
      let currentIndex = 0;
      let autoPlayInterval = null;
      let isTransitioning = false;
      
      const updateSlider = (direction = 'next') => {
        if (isTransitioning) return;
        isTransitioning = true;
        
        // Remove active class from all slides
        slides.forEach((slide, index) => {
          slide.classList.remove('active_new', 'slide-in_new', 'slide-out_new');
          
          if (index === currentIndex) {
            slide.classList.add('active_new', 'slide-in_new');
          } else if (index === currentIndex - 1 || (currentIndex === 0 && index === slides.length - 1)) {
            slide.classList.add('slide-out_new');
          }
        });
        
        // Update dots
        if (dots && dots.length > 0) {
          dots.forEach((dot, index) => {
            dot.classList.toggle('active_new', index === currentIndex);
          });
        }
        
        setTimeout(() => {
          isTransitioning = false;
        }, 300);
      };
      
      const goToSlide = (index) => {
        if (index < 0) index = slides.length - 1;
        if (index >= slides.length) index = 0;
        currentIndex = index;
        updateSlider();
      };
      
      const nextSlide = () => {
        goToSlide(currentIndex + 1);
        {%- if section.settings.pairs_well_with_auto_play -%}
          stopAutoPlay();
          startAutoPlay();
        {%- endif -%}
      };
      
      const prevSlide = () => {
        goToSlide(currentIndex - 1);
        {%- if section.settings.pairs_well_with_auto_play -%}
          stopAutoPlay();
          startAutoPlay();
        {%- endif -%}
      };
      
      // Dot navigation
      if (dots && dots.length > 0) {
        dots.forEach((dot, index) => {
          dot.addEventListener('click', () => {
            goToSlide(index);
            {%- if section.settings.pairs_well_with_auto_play -%}
              stopAutoPlay();
              startAutoPlay();
            {%- endif -%}
          });
        });
      }
      
      // Touch/swipe support
      let touchStartX = 0;
      let touchStartY = 0;
      let isDragging = false;
      let touchThreshold = 50;
      let hasMoved = false;
      
      container.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        isDragging = true;
        hasMoved = false;
        container.style.userSelect = 'none';
        container.style.webkitUserSelect = 'none';
      }, { passive: true });
      
      container.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        const touchCurrentX = e.touches[0].clientX;
        const touchCurrentY = e.touches[0].clientY;
        const diffX = Math.abs(touchStartX - touchCurrentX);
        const diffY = Math.abs(touchStartY - touchCurrentY);
        
        // Se ainda não moveu o suficiente, não previne o scroll
        if (diffX < 10 && diffY < 10) {
          return;
        }
        
        // Marca como movido se ainda não foi marcado
        if (!hasMoved) {
        hasMoved = true;
        }
        
        // Só previne o scroll se o movimento for principalmente horizontal
        if (diffX > diffY && diffX > 10) {
          e.preventDefault();
        }
      }, { passive: false });
      
      container.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        
        container.style.userSelect = '';
        container.style.webkitUserSelect = '';
        
        // Só executa o swipe se foi um movimento horizontal claro
        if (hasMoved && Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > touchThreshold) {
          if (diffX > 0) {
            // Swipe left - next slide
            nextSlide();
          } else {
            // Swipe right - previous slide
            prevSlide();
          }
        }
        
        isDragging = false;
        hasMoved = false;
      }, { passive: true });
      
      // Mouse drag support for desktop
      let mouseDown = false;
      let mouseStartX = 0;
      let mouseStartY = 0;
      
      container.addEventListener('mousedown', (e) => {
        // Prevent text selection
        e.preventDefault();
        mouseDown = true;
        mouseStartX = e.clientX;
        mouseStartY = e.clientY;
        container.style.cursor = 'grabbing';
        container.style.userSelect = 'none';
        container.style.webkitUserSelect = 'none';
        slider.style.userSelect = 'none';
        slider.style.webkitUserSelect = 'none';
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!mouseDown) return;
        e.preventDefault();
      });
      
      document.addEventListener('mouseup', (e) => {
        if (!mouseDown) return;
        
        const diffX = mouseStartX - e.clientX;
        const diffY = mouseStartY - e.clientY;
        
        container.style.cursor = 'grab';
        container.style.userSelect = '';
        container.style.webkitUserSelect = '';
        slider.style.userSelect = '';
        slider.style.webkitUserSelect = '';
        
        // Only trigger slide if horizontal movement is greater than vertical
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          if (diffX > 0) {
            // Drag left - next slide
            nextSlide();
          } else {
            // Drag right - previous slide
            prevSlide();
          }
        }
        
        mouseDown = false;
      });
      
      // Keyboard navigation
      container.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          prevSlide();
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          nextSlide();
        }
      });
      
      // Auto-play (optional)
      const startAutoPlay = () => {
        {%- if section.settings.pairs_well_with_auto_play -%}
          if (autoPlayInterval) clearInterval(autoPlayInterval);
          
          autoPlayInterval = setInterval(() => {
            nextSlide();
          }, {{ section.settings.pairs_well_with_auto_play_interval | default: 5000 }});
        {%- endif -%}
      };
      
      const stopAutoPlay = () => {
        if (autoPlayInterval) {
          clearInterval(autoPlayInterval);
          autoPlayInterval = null;
        }
      };
      
      {%- if section.settings.pairs_well_with_auto_play -%}
        startAutoPlay();
        
        // Pause on hover
        slider.addEventListener('mouseenter', stopAutoPlay);
        slider.addEventListener('mouseleave', startAutoPlay);
      {%- endif -%}
      
      // Initialize
      updateSlider();
    })();
  </script>

  <style>
    .pairs-well-with_new {
      margin-top: 20px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .pairs-well-with-title_new {
      font-size: 18px !important;
      font-weight: 700;
      color: #EB701F;
      margin-bottom: 30px;
      text-align: left;
    }

    .pairs-well-with-slider_new {
      position: relative;
      width: 100%;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
    }

    .pairs-well-with-container_new {
      position: relative;
      width: 100%;
      transition: transform 0.3s ease;
      cursor: grab;
    }

    .pairs-well-with-container_new:active {
      cursor: grabbing;
    }

    .pairs-well-with-slide_new {
      display: none;
      width: 100%;
      opacity: 0;
      transform: translateX(20px);
      transition: opacity 0.3s ease
      , transform 0.3s ease;
    }

    .pairs-well-with-slide_new.active_new {
      display: block;
      opacity: 1;
      transform: translateX(0);
    }

    .pairs-well-with-slide_new.slide-in_new {
      animation: slideIn 0.3s ease forwards;
    }

    .pairs-well-with-slide_new.slide-out_new {
      animation: slideOut 0.3s ease forwards;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-30px);
      }
    }


    .pairs-well-with-content_new {
      display: flex;
      gap: 30px;
      align-items: center;
    }


    .pairs-well-with-image-link_new {
      display: block;
      width: 100%;
      aspect-ratio: 1;
      background: #F2F2F2;
      width: 200px;
      height: 130px;
      border-radius: 20px;
    }

    .pairs-well-with-image_new {
      width: 200px;
      height: 130px;
      object-fit: contain;
      padding: 20px;
      display: block;
    }

    .pairs-well-with-image-placeholder_new {
      width: 100%;
      aspect-ratio: 1;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pairs-well-with-info-wrapper_new {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .pairs-well-with-product-title_new {
      margin: 0 !important;
      font-size: 18px !important;
      font-weight: 600;
      line-height: 18px !important;
    }

    .pairs-well-with-product-title_new a {
      color: #000;
      text-decoration: none;
      transition: color 0.2s;
    }

    .pairs-well-with-product-title_new a:hover {
      color: #EB701F;
    }

    .pairs-well-with-price_new {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .pairs-well-with-price-current_new {
      font-size: 20px !important;
      font-weight: 700;
      color: #EB701F;
    }

    .pairs-well-with-price-original_new {
      font-size: 15px !important;
      color: #999;
      text-decoration: line-through;
    }

    .pairs-well-with-form_new {
      margin: 0;
    }

    .pairs-well-with-add-btn_new {
      width: 100%;
      max-width: fit-content !important;
      padding: 4px 50px !important;
      background: #EB701F;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s;
    }

    .pairs-well-with-add-btn_new:hover:not(:disabled) {
      background: #d85f0f;
    }

    .pairs-well-with-add-btn_new:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .pairs-well-with-dots_new {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .pairs-well-with-dot_new {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      background: #fff;
      border: 1px solid #000;
      cursor: pointer;
      padding: 0;
      transition: all 0.3s ease;
    }

    .pairs-well-with-dot_new.active_new {
      background: #000;
      width: 32px;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      .pairs-well-with-price_new{
        justify-content: center;
      }
      .pairs-well-with-form_new{
        text-align: center;
      }
      .pairs-well-with_new {
        padding: 0 15px;
        margin-top: 40px;
      }

      .pairs-well-with-title_new {
        font-size: 24px;
        margin-bottom: 20px;
      }

      .pairs-well-with-content_new {
        flex-direction: column;
        gap: 30px;
      }

      .pairs-well-with-info-wrapper_new {
        width: 100%;
      }

      .pairs-well-with-product-title_new {
        font-size: 22px;
        text-align: center;
      }

      .pairs-well-with-price-current_new {
        font-size: 28px;
      }

      .pairs-well-with-price-original_new {
        font-size: 20px;
      }

      .pairs-well-with-add-btn_new {
        max-width: 100%;
        padding: 16px 24px;
        font-size: 14px;
      }
    }
  </style>
{%- endif -%}