{% comment %}
  Cart Drawer Items Snippet
  Renders the list of items in the cart drawer
{% endcomment %}

{% if cart.item_count == 0 %}
  <div class="cart-drawer__empty">
    <div class="cart-drawer__empty-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
    </div>
    <p class="cart-drawer__empty-text">Your cart is empty</p>
    <a href="{{ routes.all_products_collection_url }}" class="button button--secondary">
      Continue Shopping
    </a>
  </div>
{% else %}
  <div class="cart-drawer__items-list">
    {% for item in cart.items %}
      <div class="cart-item" id="CartDrawer-Item-{{ item.index | plus: 1 }}" data-index="{{ item.index | plus: 1 }}">
        
        {%- comment -%} Item Image {%- endcomment -%}
        <div class="cart-item__image">
          {% if item.image %}
            <img 
              src="{{ item.image | image_url: width: 150 }}"
              alt="{{ item.image.alt | escape }}"
              width="150"
              height="{{ 150 | divided_by: item.image.aspect_ratio | ceil }}"
              loading="lazy"
            >
          {% endif %}
        </div>

        {%- comment -%} Item Details {%- endcomment -%}
        <div class="cart-item__details">
          
          {%- comment -%} Title {%- endcomment -%}
          <a href="{{ item.url }}" class="cart-item__title">
            {{ item.product.title | escape }}
          </a>

          {%- comment -%} Variant {%- endcomment -%}
          {% unless item.product.has_only_default_variant %}
            <div class="cart-item__variant">
              {{ item.variant.title }}
            </div>
          {% endunless %}

          {%- comment -%} Properties {%- endcomment -%}
          {% unless item.properties == empty %}
            <div class="cart-item__properties">
              {% for property in item.properties %}
                {% assign property_first_char = property.first | slice: 0 %}
                {% unless property.last == blank or property_first_char == '_' %}
                  <div class="cart-item__property">
                    <span>{{ property.first }}: </span>
                    <span>
                      {% if property.last contains '/uploads/' %}
                        <a href="{{ property.last }}">{{ property.last | split: '/' | last }}</a>
                      {% else %}
                        {{ property.last }}
                      {% endif %}
                    </span>
                  </div>
                {% endunless %}
              {% endfor %}
            </div>
          {% endunless %}

          {%- comment -%} Price with Discount Info {%- endcomment -%}
          <div class="cart-item__price">
            {%- comment -%} Calculate savings {%- endcomment -%}
            {%- assign has_discount = false -%}
            {%- assign savings = 0 -%}
            
            {%- comment -%} Check compare_at_price from variant {%- endcomment -%}
            {%- if item.variant.compare_at_price and item.variant.compare_at_price > item.price -%}
              {%- assign has_discount = true -%}
              {%- assign per_unit_savings = item.variant.compare_at_price | minus: item.price -%}
              {%- assign savings = per_unit_savings | times: item.quantity -%}
            {%- endif -%}

            {%- comment -%} Or check original vs final line price {%- endcomment -%}
            {%- if has_discount == false and item.original_line_price > item.final_line_price -%}
              {%- assign has_discount = true -%}
              {%- assign savings = item.original_line_price | minus: item.final_line_price -%}
            {%- endif -%}

            <div class="cart-item__price-wrapper">
              <span class="cart-item__final-price">
                {{ item.final_line_price | money }}
              </span>
              
              {%- if has_discount -%}
                <span class="cart-item__old-price">
                  {{ item.original_line_price | money }}
                </span>
              {%- endif -%}
            </div>
            
            {%- comment -%} Savings Badge {%- endcomment -%}
            {%- if has_discount and savings > 0 -%}
              <div class="cart-item__savings-badge">
                You save {{ savings | money }}
              </div>
            {%- endif -%}

            {%- comment -%} Line Level Discounts (automatic discounts or discount codes) {%- endcomment -%}
            {%- if item.line_level_discount_allocations.size > 0 -%}
              <div class="cart-item__discounts">
                {%- for discount_allocation in item.line_level_discount_allocations -%}
                  <div class="cart-item__discount-badge">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <path d="M7 0L8.5 5L13 5L9.25 8L10.75 13L7 10L3.25 13L4.75 8L1 5L5.5 5L7 0Z" fill="currentColor"/>
                    </svg>
                    <span class="cart-item__discount-title">{{ discount_allocation.discount_application.title }}</span>
                    <span class="cart-item__discount-amount">-{{ discount_allocation.amount | money }}</span>
                  </div>
                {%- endfor -%}
              </div>
            {%- endif -%}
          </div>

          {%- comment -%} Quantity Selector {%- endcomment -%}
          <div class="cart-item__quantity">
            <label class="visually-hidden" for="Drawer-quantity-{{ item.index | plus: 1 }}">
              Quantity
            </label>
            <quantity-input class="quantity" data-line="{{ item.index | plus: 1 }}">
              <button 
                class="quantity__button" 
                name="minus" 
                type="button"
                data-line="{{ item.index | plus: 1 }}"
                data-quantity="{{ item.quantity | minus: 1 }}"
                {% if item.quantity <= 1 %}disabled{% endif %}
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="2" viewBox="0 0 12 2" fill="none">
                  <path d="M11 1H1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
              <input 
                class="quantity__input"
                type="number"
                name="updates[]"
                value="{{ item.quantity }}"
                min="1"
                aria-label="Quantity for {{ item.product.title | escape }}"
                id="Drawer-quantity-{{ item.index | plus: 1 }}"
                data-line="{{ item.index | plus: 1 }}"
              >
              <button 
                class="quantity__button" 
                name="plus" 
                type="button"
                data-line="{{ item.index | plus: 1 }}"
                data-quantity="{{ item.quantity | plus: 1 }}"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M11 6H1M6 11V1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
            </quantity-input>

            <cart-remove-button 
              id="CartDrawer-Remove-{{ item.index | plus: 1 }}" 
              data-line="{{ item.index | plus: 1 }}"
            >
              <button
                type="button"
                class="cart-item__remove"
                aria-label="Remove {{ item.title | escape }}"
              >
                Remove
              </button>
            </cart-remove-button>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

